---
title: 秒杀场景
order: 3
author: zzys
date: 2023-10-07
category:
- 笔记
tag:
- 秒杀
- 实战
---

秒杀场景设计主要看以下三点：

- 高可用
- 高性能
- 最终一致性

秒杀场景的特点：

- 读多写少
- 瞬时流量
- 流程简单

下面就从前端到后端链路的分析和设计秒杀场景。

参考：

[万字超详解秒杀系统！](https://zhuanlan.zhihu.com/p/433618121)

[面试官问我：如何设计一个秒杀场景？](https://cloud.tencent.com/developer/article/1833184)

[高频面试题：秒杀场景设计 ](https://zhuanlan.zhihu.com/p/273302387)

[秒杀常见问题（超卖问题）](https://zhuanlan.zhihu.com/p/165638059)

## 业务

可以适当增加参与秒杀的条件

## 前端

- 前端静态化，并搭配CDN减少服务器的压力
- 在尚未开始前，将button置为灰色，减少不必要的请求。
- 设置验证码或答题，将请求打散。

## 网关

对于一些高频访问的拉入黑名单中。还有一些比如在10点开抢，10点准时到达的请求，也一并拦截，因为验证码和答题不可能有那么快。

## 后端

- 活动预热，将热点数据提前缓存到redis中
- 非核心服务的降级，限流，拒绝，将非核心的业务暂时降级处理，将资源在短时间内先留给核心业务。
- 核心服务的限流处理，比如秒杀1000件商品，当请求量大于10000后就快速返回失败（令牌桶）。

- 采用redis库存预扣减。
- 使用消息队列异步下单。

在后端保证数据的一致性，即超卖问题。

- 采用分布式锁。
- 采用分布式事务。
- 在数据库减库存时加上**库存数量判断**，防止数据变为负数。
- 如果只允许抢购一单，那么需要数据库加**唯一索引**，防止用户重复购买，也可以采用分布式锁，对于一个用户进行加锁，如果一个用户的多个抢购请求并发的到达，`tryLock`失败的请求快速返回响应。

步骤：

1. 首先将库存缓存在redis中。
2. 当请求到达时先在redis中进行库存预扣减，当redis中库存不足时返回失败。
3. 采用消息队列异步下单。
4. 扣库存的时候先扣数据库库存，再扣减redis库存，保证在同一个事务里。数据库扣减库存时加入`where 库存 > 0`。
5. 客户端轮询是否下单成功。

